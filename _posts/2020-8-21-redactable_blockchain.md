---
layout: post
title:  "redactalbe blockchain"
date:   2020-8-21 12:20:01
categories: thoughts
tags: chameleon hash redactable blockchain tee
---

* content
{:toc}

---
# Table of Contents

1.  [为什么需要可编辑区块链](#orge6465e5)
    1.  [数据有“被遗忘”的权利(q1)](#org41223c5)
    2.  [链上垃圾太多(q2)](#orgb11d30b)
    3.  [恶意攻击造成的损失(q3)](#org3cdb0ba)
    4.  [不合法数据上链(q4)](#org216ecb3)
2.  [可编辑从技术上，分为两类问题：](#orgf006f3f)
    1.  [物理删除数据(q5)](#org88d26e1)
    2.  [回滚交易 (q6)](#org8ef13f3)
    3.  [物理删除交易(q7)](#orgfd6d4f0)
3.  [是否允许回滚，是共识机制问题](#orgabac4f0)
    1.  [协商一致回滚](#org4990de6)
    2.  [S和R 协商不一致，可能有人作恶](#org4660dfe)
    3.  [如果回滚交易t，那么所有依赖交易t的交易怎么回滚？](#org8f539c1)
4.  [技术上如何支持修改？](#orgc91c822)
    1.  [chemoleon hash 方案](#org2948b83)
    2.  [不依赖密码学方法的方案。](#org0fefd8c)
5.  [缺陷：](#orgfc63a34)
    1.  [区块链失去了不可篡改性？](#org02f4ba2)
    2.  [修改在区块粒度，性能差？](#orgb76f8c3)
    3.  [是否还能支持跨链？](#org77d7309)
    4.  [chameleon hash的密钥的管理](#org0141daf)
6.  [改进思路：](#org0405840)
    1.  [TEE 替换chameleon hash？](#orgc9abd22)
    2.  [q5的解决方案新思路](#org8bc14f1)
        1.  [可编辑方案](#org519427e)
        2.  [不可编辑方案](#org942b68c)
        3.  [q6 思考](#org12de782)
7.  [一种设计思路](#org3b6eff3)
    1.  [双链架构](#orgc7f814e)
    2.  [修改链的共识算法](#org2bca029)
    3.  [处理“依赖交易”的回滚](#org835b515)
    4.  [chamelon hash密钥保存和使用](#orgc935b9f)
    5.  [支持“跨链”](#org35edae7)
    6.  [技术实现：](#org84790ee)

可编辑区块链 Redactable Blockchain


<a id="orge6465e5"></a>

# 为什么需要可编辑区块链


<a id="org41223c5"></a>

## 数据有“被遗忘”的权利(q1)

大家基本都是引用欧盟的隐私保护法律。


<a id="orgb11d30b"></a>

## 链上垃圾太多(q2)

很多实际落地案例，区块链用法不对？


<a id="org3cdb0ba"></a>

## 恶意攻击造成的损失(q3)

这种攻击主要是针对交易，联盟链上某种通证的交易。

需要有办法回滚交易，挽回损失。


<a id="org216ecb3"></a>

## 不合法数据上链(q4)

联盟链需要拥抱内容审核


<a id="orgf006f3f"></a>

# 可编辑从技术上，分为三类问题：


<a id="org88d26e1"></a>

## 物理删除数据(q5)

保证全局视图中没有某条数据。意味着：一个新节点加入链上后，从正确leader中同步不到已经被删除的数据。但是原来有被删除数据的节点，继续私自保存着该条数据，是不可能有技术手段解决的。


<a id="org8ef13f3"></a>

## 回滚交易 (q6)

回滚交易，等于逻辑删除。交易原始数据本身还存在链上，但是被认定为无效。

<a id="orgfd6d4f0"></a>

## 物理删除交易(q7)

似乎没有意义。

公开交易不涉及用户隐私，没有“被遗忘”的权利。交易如果涉及用户隐私，可以采用"隐私交易"技术。

当某些用户对某条交易产生了异议时，只要决定是否回滚就行。对于采用隐私保护技术的隐私交易，也可以进行回滚即可。


<a id="orgabac4f0"></a>

# 是否允许回滚，是共识机制问题

是否允许交易回滚，是共识机制问题，不是技术问题。

分四种情况讨论：


<a id="org4990de6"></a>

## S和R协商一致回滚

交易的双方，发起者S 和接收者R都同意，允许回滚。

这种场景不需要可编辑区块链。R 重新发起一笔给S的交易，与原交易相抵消，就ok了。


<a id="org4660dfe"></a>

## S和R 协商不一致，可能有人作恶

显然涉及现实世界中的问题，技术手段无法判断谁作恶，是否应该回滚。

所有参与者pos投票，委员会投票，硬分叉用脚站队，特权机构仲裁。

## S和R无异议，监管部门认定不合规

由监管部门审核决定，无需参与者投票，应该直接生效。

<a id="org8f539c1"></a>

## 如果回滚交易t，那么所有依赖交易t的交易怎么回滚？

同样不是一个技术问题。选择全部回滚，或者部分回滚，只能再次依赖委员会投票或者仲裁。

回滚依赖交易的问题被学界和工业界选择性忽略，因为太复杂。如果要解决这个问题，系统会变得很复杂，工程量很大。

我们也忽略这个问题。


<a id="orgc91c822"></a>

# 技术上如何支持修改？

有两种方案，目前有两种技术方案：基于chemeleon hash的方案和 不用额外hash的方案。


<a id="org2948b83"></a>

## chemoleon hash 方案

假设没有任何交易依赖交易t，只需要回滚交易t本身。

假设N 块上有交易t1。在任意区块N+K 上，发一条交易t2，声明t1无效，应该改为t1'，并且提供允许修改的证据，委员会投票结果或者毒菜签名。

t2包含了构造出的另一个交易t1'，使hash(t1') = hash(t1)。

这样不用改原来的账本结构，所有的区块头不变，只把区块内容部分中t1的内容改成t1'。

这种方式可以实现对任意交易的逻辑删除、物理删除、和修改。


<a id="org0fefd8c"></a>

## 不依赖密码学方法的方案。

任何一条交易transaction的内容 看做三元组（content, Null, p）。 p为选择策略，交易的实际内容可以为content 或者null。可以使用某一种默认策略，比如默认为content。

假设在 Delta<sub>blocks</sub> 个区块内可以修改该条交易。通过投票或仲裁之后，一条“元交易”上链，指示内容变更为Null。

可以使用逻辑删除、修改，但无法实现物理删除。因为三元组必须保持原样，才能保证整个区块链通过正确的hash连接起来。


<a id="orgfc63a34"></a>

# 可编辑区块链的缺陷：


<a id="org02f4ba2"></a>

## 区块链失去了不可篡改性？

持有变色龙哈希函数私钥的人偷偷改怎么办。假设出现了两个参与者 P1 和 P2 对t1 和 伪造的t1'哪个合法产生了疑问怎么办？

虽然只有持有私钥的人才能做出hash(t1') = hash(t1)，但是没有任何证据能证明合法的数据应该是t1 or t1'。

如何解决：再次投票或仲裁。选择为t1 or t1' 背书。只要所有参与者信任共识机制（投票或仲裁），安全性得以保证。

但是区块链的确是失去了不可篡改性。当交易双方看到交易已经上链上，还无法把它当成不会再改变的，还不能基于该交易进行其他现实世界中的活动。

解决方案：可编辑时间窗口、向仲裁结构申请确认。类似电商的收货确认。


<a id="orgb76f8c3"></a>

## 修改在区块粒度，性能差？

Accenture原版方案是在区块粒度修改，很容易将其修改为在交易级别。

<a id="org77d7309"></a>

## 是否还能支持跨链？

如何失去了不可篡改性，不再支持跨链。

如果能通过上述解决方案，同时满足“不可篡改性”，还能支持跨链。


<a id="org0141daf"></a>

## chameleon hash的密钥的管理

目前采用秘密分享协议，mpc方案等。大部分研究、专利主要在考虑chameleon hash密钥的管理和使用方面。

而且chemelon hash 密钥的使用过程，还跟修改共识的执行耦合在一起，非常复杂，正确性未知。


<a id="org0405840"></a>

# 现有方案改进思路：

<a id="orgc9abd22"></a>

## TEE 替换chameleon hash？

chamelon hash 必须有。可以用TEE来保护chameleon hash私钥。TEE替换的是私钥的保管使用的方案。

<a id="org8bc14f1"></a>

## q5的解决方案新思路


<a id="org519427e"></a>

### 可编辑方案

基于chameleon hash 方案


<a id="org942b68c"></a>

### 不可编辑方案

也可以有一种不需要“可编辑区块链”的方案。用户在上传数据到链上前，必须向一个可信审核程序，可以是监管机构的web服务，或者TEE中的内容审核程序请求审核，通过审核后，形成一个证据文件。然后该条数据类型的交易可以安全上链，该交易之后不可修改。

该方案适用性不一定好，监管机构可能不想承担这么多的任务。还是上一种方案好。


<a id="org12de782"></a>

## q6 思考

虽然有依赖chameleon hash和不依赖chameleon hash 两种方案。

但是考虑q5基于chameleon hash，还是使用chemeleon hash比较好。


<a id="org3b6eff3"></a>

# 一种设计思路

一个idea经过100次迭代，才能成为是一个好idea。以下方案算是第二次迭代。


<a id="orgc7f814e"></a>

## 双链架构

上文分析提到，是否允许修改某条交易，是一个极其复杂的问题。需要专门设计的共识算法来解决。最好是不要把这个修改共识算法 与 原来的链耦合在一起，单独拿出来，从技术上也比较容易实现。


<a id="org2bca029"></a>

## 修改链的共识算法

修改链上的交易包含，某个参与者提交的修改proposal，或者申请确定某条交易的proposal。
监管部分拥有最终决定权。
监管部门中立时，pos投票。


<a id="org835b515"></a>

## 处理“依赖交易”的回滚

fabric不使用utxo模型，不存在强依赖，不会使链出错，但有可能使某些用户权利受损失。

通过两种方式可以解决该问题：

每个交易有"可编辑时间窗口"，超过窗口期无法回滚。因此用户要对自己的行为负责，不要依赖于没有最终确认的交易。

用户假设想要回滚多条交易，在修改链上发出多条修改proposal，所有用户和监管部门通过协商处理。


<a id="orgc935b9f"></a>

## chamelon hash密钥保存和使用

密钥保存在一个tee中。当修改链上达成一条修改共识后，tee执行修改。

该方案比起秘密共享协议，简单实用多了。


<a id="org35edae7"></a>

## 支持“跨链”

同上分析，设置一个“可编辑时间窗口”，或者可在修改链上提交申请确定交易的proposal。

不可修改的交易就可以安全地跨链了。


<a id="org84790ee"></a>

## 技术实现：

实现不难。

主链fabric的修改不难。chameleon hash比较容易，找一个库用即可。

修改链其实不一定是一条链。因为普通区块链链节点的共识不需要人工参与。而修改链上，参与者需要思考支持或反对修改，然后手动投票。其实实现的是一个投票系统。

还可以更简单一点，让监管部门用户chameleon hash私钥，所有修改操作都由监管机构授权。这个方案似乎理想化了，监管部门是否愿意承担这个责任？

如果信通院的监管链的项目还有后续深入，用得上这套技术方案。

# 参考文献：
《可编辑区块链: 模型、技术与方法》 袁勇  王飞跃
